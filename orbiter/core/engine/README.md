# ‚öôÔ∏è Rule Engine & State Machine (`orbiter/core/engine/`)

## üéØ Single Responsibility Principle (SRP)
The `engine/` directory handles the **Decision-Making Pipeline**. It evaluates market facts against dynamically loaded JSON rules and dispatches trading actions based on the active strategy.

## üìÇ Architecture

### 1. `session/` (Context & State)
- **`session_manager.py`:** Resolves the active strategy based on CLI arguments or system defaults. Loads the strategy bundle (rules, filters, instruments). Provides session-wide facts (is market open?).
- **`state_manager.py`:** Maintains the in-memory representation of the portfolio (active positions, realized PnL, available margin).

### 2. `rule/` (Evaluation)
- **`rule_manager.py`:** Compiles the JSON strategy rules into executable Python logic.
- **`fact_calculator.py` & `technical_analyzer.py`:** Generate real-time indicators (EMA, RSI, ATR) that the rules depend on.
- **`fact_converter.py`:** Normalizes data types for rule comparisons.

### 3. `action/` (Execution Dispatch)
- **`action_manager.py`:** Queues and batches actions generated by the `RuleManager`.
- **`executor.py`:** Dispatches actions (like `buy_asset`, `update_sl`) to specific registered handlers.
- **`executors/`:** Segment-specific implementation details (Equity vs. Futures vs. Options).

### 4. `builder/` (Factory)
- **`engine_factory.py`:** Bootstraps the `CoreEngine` by stitching together the state, session, and action managers.

### 5. `runtime/` (The Heartbeat)
- **`core_engine.py`:** The `tick()` method. It processes live websockets data, updates trailing stop losses, evaluates custom filters (like premium degradation or trend mortality), and commits state changes.
- **`syncer.py`:** Synchronizes the internal `StateManager` with the actual Broker backend to prevent "Amnesia" or "Ghost Positions".
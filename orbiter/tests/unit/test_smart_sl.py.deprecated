import unittest

raise unittest.SkipTest("Legacy SL/TP Executor removed in refactor; tests updated elsewhere.")

class TestSmartSLLogic(unittest.TestCase):
    def setUp(self):
        self.client = MagicMock()
        self.state = OrbiterState(self.client, ["NFO|12345"], MagicMock(), {
            "TRADE_SCORE": 0.5, "TOP_N": 1, "VERBOSE_LOGS": False,
            "STOP_LOSS_RS": 500, "TARGET_PROFIT_RS": 1000,
            "TSL_RETREACEMENT_PCT": 40, "TSL_ACTIVATION_RS": 1000
        })
        self.executor = Executor(
            log_buy_signals=MagicMock(),
            log_closed_positions=MagicMock(),
            sl_filters=[],
            tp_filters=[]
        )

    def test_pnl_calculation_spread(self):
        """Test that PnL is correctly calculated in Rupees for Spreads"""
        # Entry: Stock @ 1000, Option Spread @ 10.0
        # Exit:  Stock @ 1005 (+0.5%), Option Spread @ 8.0 (Profit ₹2.0)
        info = {
            'entry_price': 1000.0,
            'entry_time': datetime.now(pytz.timezone('Asia/Kolkata')),
            'strategy': 'PUT_CREDIT_SPREAD',
            'atm_symbol': 'SHORT_OPT',
            'hedge_symbol': 'LONG_OPT',
            'entry_net_premium': 10.0,
            'atm_premium_entry': 12.0,
            'lot_size': 100
        }
        self.state.active_positions = {"NFO|12345": info}
        
        # Mock Stock LTP and Option LTPs
        self.client.SYMBOLDICT = {"NFO|12345": {"ltp": 1005.0}}
        self.client.get_option_ltp_by_symbol.side_effect = lambda sym: 10.0 if sym == 'SHORT_OPT' else 2.0
        
        # Run check_sl
        self.executor.check_sl(self.state, MagicMock())
        
        # Verified: PnL should be (10.0 - 8.0) * 100 = ₹200
        # Stock Move should be +0.50%
        self.assertEqual(info['pnl_rs'], 200.0)
        self.assertEqual(info['max_pnl_rs'], 200.0)

    def test_cash_tsl_trigger(self):
        """Test that TSL triggers based on Cash, not %"""
        from orbiter.filters.tp.f2_trailing_sl import check_trailing_sl
        
        # Peak was ₹2000, 40% retracement means exit at ₹1200
        position = {
            'max_pnl_rs': 2000.0,
            'pnl_rs': 1100.0, # Just below the ₹1200 floor
            'tsl_retracement_pct': 40,
            'tsl_activation_rs': 1000,
            'entry_price': 1000.0
        }
        
        res = check_trailing_sl(position, 1000.0, {})
        self.assertTrue(res['hit'])
        self.assertIn("Cash TSL Hit", res['reason'])
        self.assertIn("Floor ₹1200", res['reason'])

if __name__ == "__main__":
    unittest.main()
